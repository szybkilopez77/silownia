<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Si≈Çownia Tracker</title>
  <link rel="stylesheet" href="glowna.css" />
  <link rel="manifest" href="manifest.json" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>

  <script>
    // --- TWOJA KONFIGURACJA FIREBASE (wstawiony nowy apiKey) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAppNtKEUxyLV4KHMKEjqmAbr8Nd2Fo568",
      authDomain: "silownia-tracker.firebaseapp.com",
      databaseURL: "https://silownia-tracker-default-rtdb.firebaseio.com",
      projectId: "silownia-tracker",
      storageBucket: "silownia-tracker.firebasestorage.app",
      messagingSenderId: "784475778284",
      appId: "1:784475778284:web:124964d9545d32014ec9c9",
      measurementId: "G-VLRXR428KH"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- ZAPIS DO FIREBASE (nadpisuje wƒôze≈Ç 'workouts' listƒÖ) ---
    function saveDataToCloud(workoutsArray) {
      // zapisuje ca≈ÇƒÖ tablicƒô do /workouts
      return firebase.database().ref("workouts").set(workoutsArray)
        .then(() => console.log("‚úÖ Dane zapisane w chmurze"))
        .catch(err => console.error("‚ùå B≈ÇƒÖd zapisu do chmury:", err));
    }

    // --- POBIERZ DANE Z CHMURY (zwraca Promise -> tablica) ---
    function fetchDataFromCloud() {
      return firebase.database().ref("workouts").once("value")
        .then(snapshot => {
          const val = snapshot.val();
          if (!val) return [];
          // Za≈Ç√≥≈ºmy, ≈ºe val jest tablicƒÖ lub obiektem - przekszta≈Çƒá do tablicy
          if (Array.isArray(val)) return val;
          // Je≈õli kto≈õ zapisa≈Ç obiekt, zamieniamy na tablicƒô
          return Object.values(val);
        })
        .catch(err => {
          console.error("‚ùå B≈ÇƒÖd pobierania z chmury:", err);
          return [];
        });
    }
  </script>
</head>
<body>
  <h1>Si≈Çownia üèãÔ∏è‚Äç‚ôÇÔ∏è</h1>

  <!-- MENU G≈Å√ìWNE -->
  <div class="menu" id="menu" style="display:flex;gap:10px;">
    <button onclick="showSection('trainingMenu')">Trening</button>
    <button onclick="showSection('wykres')">Wykres postƒôpu</button>
  </div>

  <!-- MENU WYBORU TRENINGU -->
  <div class="training-menu" id="trainingMenu" style="display:none;">
    <h2>Wybierz rodzaj treningu</h2>
    <button onclick="startWorkout('PUSH')">PUSH</button>
    <button onclick="startWorkout('PULL')">PULL</button>
    <button onclick="startWorkout('LEGS')">LEGS</button>
    <button class="back-btn" onclick="goBack()">‚¨Ö Powr√≥t</button>
  </div>

  <!-- FORMULARZ TRENINGU -->
  <div class="container" id="trening" style="display:none;">
    <h2 id="trainingTypeTitle">Trening</h2>
    <h3 id="exerciseName"></h3>
    <form id="workout-form"></form>
    <!-- wa≈ºne: type="button" -->
    <button id="next-btn" type="button">Dalej ‚û°</button>
    <button class="back-btn" onclick="showSection('trainingMenu')">‚¨Ö Powr√≥t</button>
  </div>

  <!-- WYKRES + TABELA -->
  <div class="chart-container" id="wykres" style="display:none;">
    <h2>Postƒôp treningowy</h2>

    <div class="filter-buttons" id="chartMenu">
      <button class="push" onclick="selectChartType('PUSH')">PUSH</button>
      <button class="pull" onclick="selectChartType('PULL')">PULL</button>
      <button class="legs" onclick="selectChartType('LEGS')">LEGS</button>
    </div>

    <div id="dateMenu" style="display:none;">
      <h3>Wybierz datƒô treningu:</h3>
      <div id="dateButtons"></div>
      <button class="back-btn" onclick="backToChartMenu()">‚¨Ö Powr√≥t</button>
    </div>

    <div id="chartResults" style="display:none;">
      <h3 id="selectedDateTitle"></h3>
      <table id="progress-table">
        <thead>
          <tr>
            <th>ƒÜwiczenie</th>
            <th>Seria</th>
            <th>Ciƒô≈ºar (kg)</th>
            <th>Powt√≥rzenia</th>
            <th>Data</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <canvas id="progressChart"></canvas>
      <button id="deleteWorkoutBtn" style="background-color:red;color:white;padding:10px 20px;border:none;border-radius:8px;font-size:16px;margin-top:20px;cursor:pointer;">üóë Usu≈Ñ ten trening</button>
      <br />
      <button class="back-btn" onclick="backToDateMenu()">‚¨Ö Powr√≥t do dat</button>
    </div>

    <button class="back-btn" onclick="goBack()">‚¨Ö Powr√≥t</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // --- ELEMENTY DOM ---
    const form = document.getElementById("workout-form");
    const tableBody = document.querySelector("#progress-table tbody");
    const chartCanvas = document.getElementById("progressChart");
    const trainingTypeTitle = document.getElementById("trainingTypeTitle");
    const exerciseName = document.getElementById("exerciseName");
    const nextBtn = document.getElementById("next-btn");
    const chartMenu = document.getElementById("chartMenu");
    const dateMenu = document.getElementById("dateMenu");
    const dateButtons = document.getElementById("dateButtons");
    const chartResults = document.getElementById("chartResults");
    const selectedDateTitle = document.getElementById("selectedDateTitle");
    const deleteWorkoutBtn = document.getElementById("deleteWorkoutBtn");

    let chart;
    let currentTrainingType = "";
    let exercises = [];
    let currentExerciseIndex = 0;
    let tempResults = [];
    let currentChartDate = "";

    // --- POMOCNICZE: odczyt / zapis localStorage ---
    function readLocalWorkouts() {
      try {
        return JSON.parse(localStorage.getItem("workouts")) || [];
      } catch (e) {
        return [];
      }
    }
    function writeLocalWorkouts(arr) {
      localStorage.setItem("workouts", JSON.stringify(arr || []));
    }

    // --- POMOCNICZE: scalanie tablic (unikatowe wpisy) ---
    function mergeWorkouts(localArr, cloudArr) {
      // proste unikatowanie po JSON.stringify (mo≈ºna zmieniƒá na id/timestamp)
      const seen = new Set();
      const merged = [];

      (localArr || []).concat(cloudArr || []).forEach(item => {
        try {
          const key = JSON.stringify(item);
          if (!seen.has(key)) {
            seen.add(key);
            merged.push(item);
          }
        } catch (e) {
          // ignoruj
        }
      });
      return merged;
    }

    // --- HIDE / SHOW ---
    function hideAll() {
      document.getElementById("menu").style.display = "none";
      document.getElementById("trainingMenu").style.display = "none";
      document.getElementById("trening").style.display = "none";
      document.getElementById("wykres").style.display = "none";
    }

    function showSection(section) {
      hideAll();
      document.getElementById(section).style.display =
        section === "menu" ? "flex" : "block";

      if (section === "wykres") {
        chartMenu.style.display = "block";
        dateMenu.style.display = "none";
        chartResults.style.display = "none";
      }
    }

    function goBack() {
      showSection("menu");
    }

    // --- START TRENINGU ---
    function startWorkout(type) {
      currentTrainingType = type;
      trainingTypeTitle.textContent = `Trening: ${type}`;
      exercises =
        type === "PUSH"
          ? ["≈Åawka pozioma", "Modlitewnik", "Biceps siedzƒÖc zza plec√≥w", "Rozpiƒôtka", "Hammer", "Wznosy maszyna"]
          : type === "PULL"
          ? ["PodciƒÖganie", "Triceps push down", "Triceps zza plec√≥w", "PrzyciƒÖganie wƒÖskie", "PrzyciƒÖganie szeroko", "Ty≈Ç barku"]
          : ["Przysiady", "Martwy ciƒÖg", "Suwnica", "Wykroki", "Prostowanie n√≥g", "Arnold press"];

      currentExerciseIndex = 0;
      tempResults = [];
      showExercise();
      hideAll();
      document.getElementById("trening").style.display = "block";
    }

    // --- FORMULARZ DLA ƒÜWICZENIA ---
    function showExercise() {
      const exercise = exercises[currentExerciseIndex];
      exerciseName.textContent = `ƒÜwiczenie ${currentExerciseIndex + 1}/${exercises.length}: ${exercise}`;
      form.innerHTML = "";

      for (let i = 1; i <= 3; i++) {
        const div = document.createElement("div");
        div.classList.add("exercise-set");
        div.innerHTML = `
          <label>Seria ${i}:</label><br>
          <input type="number" placeholder="Ciƒô≈ºar (kg)" class="weight" />
          <input type="number" placeholder="Powt√≥rzenia" class="reps" />
          <br><br>
        `;
        form.appendChild(div);
      }

      nextBtn.textContent =
        currentExerciseIndex < exercises.length - 1 ? "Dalej ‚û°" : "Zako≈Ñcz ‚úÖ";
    }

    // --- OBS≈ÅUGA PRZYCISKU "DALEJ"/"ZAKO≈ÉCZ" ---
    nextBtn.addEventListener("click", (e) => {
      e.preventDefault();

      const weights = [...form.querySelectorAll(".weight")].map(el => parseFloat(el.value));
      const reps = [...form.querySelectorAll(".reps")].map(el => parseInt(el.value));

      if (weights.some(isNaN) || reps.some(isNaN)) {
        alert("‚ùóWype≈Çnij wszystkie pola przed przej≈õciem dalej!");
        return;
      }

      const date = new Date().toLocaleDateString("pl-PL");

      for (let i = 0; i < 3; i++) {
        tempResults.push({
          type: currentTrainingType,
          exercise: exercises[currentExerciseIndex],
          set: i + 1,
          weight: weights[i],
          reps: reps[i],
          date,
        });
      }

      if (currentExerciseIndex < exercises.length - 1) {
        currentExerciseIndex++;
        showExercise();
      } else {
        saveWorkout();
      }
    });

    // --- ZAPISANIE TRENINGU (lokalnie + chmura) ---
    async function saveWorkout() {
      try {
        const local = readLocalWorkouts();
        const updated = [...local, ...tempResults];
        writeLocalWorkouts(updated);

        // zapis do chmury: najpierw pobierz chmurƒô, scal, a potem zapisz scalonƒÖ wersjƒô
        const cloud = await fetchDataFromCloud();
        const merged = mergeWorkouts(updated, cloud);
        await saveDataToCloud(merged);

        // zapisz scalone lokalnie (≈ºeby za chwile mieƒá sp√≥jne dane)
        writeLocalWorkouts(merged);

        // od≈õwie≈º widoki
        alert(`‚úÖ Zapisano trening ${currentTrainingType}!`);
        tempResults = [];
        showSection("menu");
      } catch (err) {
        console.error("‚ùå B≈ÇƒÖd przy zapisie treningu:", err);
        alert("‚ùå WystƒÖpi≈Ç problem przy zapisie treningu. Sprawd≈∫ konsolƒô.");
      }
    }

    // --- SELECT CHART TYPE (PUSH/PULL/LEGS) ---
    function selectChartType(type) {
      const workouts = readLocalWorkouts();
      const filtered = workouts.filter(w => w.type === type);

      if (filtered.length === 0) {
        alert("Brak zapisanych trening√≥w dla tego typu!");
        return;
      }

      const dates = [...new Set(filtered.map(w => w.date))];
      chartMenu.style.display = "none";
      dateMenu.style.display = "block";
      dateButtons.innerHTML = "";

      dates.forEach(date => {
        const btn = document.createElement("button");
        btn.textContent = date;
        btn.style.margin = "10px";
        btn.style.padding = "10px 20px";
        btn.style.fontSize = "18px";
        btn.style.border = "none";
        btn.style.borderRadius = "10px";
        btn.style.backgroundColor = "#007bff";
        btn.style.color = "white";
        btn.style.cursor = "pointer";
        btn.onclick = () => showChartForDate(type, date);
        dateButtons.appendChild(btn);
      });
    }

    function showChartForDate(type, date) {
      const workouts = readLocalWorkouts();
      const filtered = workouts.filter(w => w.type === type && w.date === date);

      currentChartDate = date;
      selectedDateTitle.textContent = `Trening: ${type} (${date})`;
      dateMenu.style.display = "none";
      chartResults.style.display = "block";

      loadTableAndChart(filtered);
    }

    function loadTableAndChart(workouts) {
      tableBody.innerHTML = "";

      workouts.forEach(entry => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.exercise}</td>
          <td>${entry.set}</td>
          <td>${entry.weight}</td>
          <td>${entry.reps}</td>
          <td>${entry.date}</td>
        `;
        tableBody.appendChild(row);
      });

      const bestPerExercise = {};
      workouts.forEach(w => {
        if (!bestPerExercise[w.exercise] || w.weight > bestPerExercise[w.exercise].weight) {
          bestPerExercise[w.exercise] = w;
        }
      });

      const labels = Object.keys(bestPerExercise);
      const data = Object.values(bestPerExercise).map(x => x.weight);

      if (chart) chart.destroy();

      chart = new Chart(chartCanvas, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Najwiƒôkszy ciƒô≈ºar (kg)",
            data,
            backgroundColor: "#007bff",
            borderWidth: 1
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    // --- USUWANIE TRENINGU (wg daty) ---
    deleteWorkoutBtn.addEventListener("click", async () => {
      if (!confirm("üóë Czy na pewno chcesz usunƒÖƒá ten trening?")) return;
      try {
        const workouts = readLocalWorkouts();
        const updated = workouts.filter(w => w.date !== currentChartDate);
        writeLocalWorkouts(updated);
        // sync do chmury
        await saveDataToCloud(updated);
        alert("‚úÖ Trening zosta≈Ç usuniƒôty!");
        backToDateMenu();
      } catch (err) {
        console.error("‚ùå B≈ÇƒÖd przy usuwaniu:", err);
        alert("‚ùå Nie uda≈Ço siƒô usunƒÖƒá treningu.");
      }
    });

    function backToChartMenu() {
      chartMenu.style.display = "block";
      dateMenu.style.display = "none";
    }

    function backToDateMenu() {
      chartResults.style.display = "none";
      dateMenu.style.display = "block";
    }

    // --- Wczytaj dane z chmury i scal z lokalnymi przy starcie ---
    async function startupSync() {
      try {
        const local = readLocalWorkouts();
        const cloud = await fetchDataFromCloud();
        const merged = mergeWorkouts(local, cloud);
        writeLocalWorkouts(merged);
        console.log("‚òÅÔ∏è Synchronizacja przy starcie zako≈Ñczona");
      } catch (err) {
        console.error("‚ùå B≈ÇƒÖd podczas startowej synchronizacji:", err);
      }
    }

    // --- START ---
    window.addEventListener("load", async () => {
      hideAll();
      document.getElementById("menu").style.display = "flex";
      await startupSync();
    });

    // --- pomoc: for debug: expose functions to window if potrzebne ---
    window._debug = {
      readLocalWorkouts,
      fetchDataFromCloud,
      saveDataToCloud
    };
  </script>

  <!-- Service Worker registration (je≈õli dodasz plik service-worker.js) -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log("‚úÖ Service Worker zarejestrowany"))
        .catch(err => console.warn("‚ùå B≈ÇƒÖd rejestracji SW:", err));
    }
  </script>
</body>
</html>


